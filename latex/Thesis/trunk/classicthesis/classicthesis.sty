% ********************************************************************
% classicthesis.sty
%
% Copyright (C) 2009 AndrÃ© Miede http://www.miede.de
%
% If you like the style then I would appreciate a postcard. My address 
% can be found in the file ClassicThesis.pdf. A collection of the 
% postcards I received so far is available online at 
% http://postcards.miede.de
%
% License:
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation; either version 2 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; see the file COPYING.  If not, write to
% the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
% Boston, MA 02111-1307, USA.
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{classicthesis}[2009/08/01 v2.6 Typographic Style for a classic-looking thesis]
	\RequirePackage{ifthen}
	\newboolean{@tocaligned} % the left column of the toc will be aligned (no indention)
\newboolean{@eulerchapternumbers} % use AMS Euler for chapter font (otherwise Palatino)
	\newboolean{@drafting} % print version information on pages
	\newboolean{@linedheaders} % chaper headers will have line above and beneath
	\newboolean{@listsseparated} % toggles the vertical space between lof/lot entries of different chapters
	\newboolean{@nochapters} % disable all chapter-specific commands 
	\newboolean{@beramono} % toggle nice monospaced font (w/ bold) + pre-installed 
	\newboolean{@eulermath} % use awesome Euler fonts for math
	\newboolean{@parts} % use part division for the text
	\newboolean{@minionpro} % setup for minion pro font
	\newboolean{@minionprospacing} % use minion pro's textssc for letter spacing
\newboolean{@pdfspacing} % use pdftex for letterspacing (via microtype)
	\newboolean{@subfig} % setup for preloaded @subfig package
	\newboolean{@a5paper} % use those tiny DIN A5 pages
	\newboolean{@dottedtoc} % page numbers in ToC flushed right
	\newboolean{@listings} % load listings package (if not already) and setup LoL

	% ********************************************************************
	% Options
	% ******************************************************************** 
	\DeclareOption{tocaligned}{\setboolean{@tocaligned}{true}}
	\DeclareOption{eulerchapternumbers}{\setboolean{@eulerchapternumbers}{true}}
	\DeclareOption{drafting}{\setboolean{@drafting}{true}}
	\DeclareOption{linedheaders}{\setboolean{@linedheaders}{true}}
	\DeclareOption{listsseparated}{\setboolean{@listsseparated}{true}}
	\DeclareOption{subfigure}{%
		\PackageWarningNoLine{classicthesis}{Package "subfigure" and option "subfigure" are deprecated, used "subfig" instead.}
		\setboolean{@subfig}{true}%
	}
\DeclareOption{subfig}{\setboolean{@subfig}{true}}
\DeclareOption{nochapters}{\setboolean{@nochapters}{true}}
\DeclareOption{beramono}{\setboolean{@beramono}{true}} 
\DeclareOption{eulermath}{\setboolean{@eulermath}{true}} 
\DeclareOption{parts}{\setboolean{@parts}{true}} 
\DeclareOption{a5paper}{\setboolean{@a5paper}{true}}
\DeclareOption{minionpro}{\setboolean{@minionpro}{true}} 
\DeclareOption{minionprospacing}{\setboolean{@minionprospacing}{true}} 
\DeclareOption{pdfspacing}{\setboolean{@pdfspacing}{true}} 
\DeclareOption{pdfspacing}{\setboolean{@pdfspacing}{true}} 
\DeclareOption{dottedtoc}{\setboolean{@dottedtoc}{true}} 
\DeclareOption{listings}{\setboolean{@listings}{true}}
\ProcessOptions\relax

% subfig-related stuff
\@ifpackageloaded{subfig}%
{\setboolean{@subfig}{true}%
}{\relax}
\@ifpackageloaded{subfigure}%
{\setboolean{@subfig}{true}%
	\PackageWarningNoLine{classicthesis}{Package "subfigure" and option "subfigure" are deprecated, %
		use "subfig" instead.}
}{\relax}
\ifthenelse{\boolean{@subfig}}%
{\PassOptionsToPackage{subfigure}{tocloft}%
}{\relax}%

% listings-related stuff
\ifthenelse{\boolean{@listings}}%
{\@ifpackageloaded{listings}%
	{\relax}{\RequirePackage{listings}}%
}{\relax}%

% fine-tuning if we use minionprospacing
\ifthenelse{\boolean{@minionprospacing}}%
{%
	\PackageInfo{classicthesis}{Using option "minionprospacing". %
		This activates "minionpro" in general and turns off %
			the option "pdfspacing".}%
			% is the user trying to use pdfspacing at the same time?    
			\ifthenelse{\boolean{@pdfspacing}}%
			{% both minionprospacing and pdfspacing are active
				\PackageWarningNoLine{classicthesis}{You cannot use "pdfspacing" at the same time %
					as "minionprospacing"!}%
			}{\relax}%
	\setboolean{@minionpro}{true}%
		\setboolean{@pdfspacing}{false}%
}{\relax}

% fine-tuning if we do not use chapters
\ifthenelse{\boolean{@nochapters}}%
{%
	% is the user trying to use parts at the same time?
		\ifthenelse{\boolean{@parts}}%
		{% both parts and nochapters are active
			\PackageWarningNoLine{classicthesis}{You cannot use "parts" at the same time %
				as "nochapters"!}%
		}{\relax}%
	% turn off some things if we do not use chapters
		\PackageInfo{classicthesis}{Using option "nochapters" (probably for an article). %
			This turns off the options "linedheaders",%
				"listsseparated", "eulerchapternumbers", and "parts". Please be aware of that.}
	\setboolean{@linedheaders}{false}%
		\setboolean{@listsseparated}{false}%
		\setboolean{@eulerchapternumbers}{false}%
		\setboolean{@parts}{false}
}{\relax}%

% ********************************************************************                
% PDF Stuff
% ********************************************************************
\RequirePackage{ifpdf}
%\ifpdf\RequirePackage{hyperref}\fi % for texorpdfstring command below


% ********************************************************************
% Font Stuff
% ********************************************************************   
\ifthenelse{\boolean{@minionpro}}%
{%
	% specialists: MinionPro
		\RequirePackage[opticals,mathlf]{MinionPro} %  opticals, fullfamily, osf
}{%
	% default: Palatino
		\RequirePackage[osf,sc]{mathpazo} % Palatino with real small caps and old style figures
		\linespread{1.05} % a bit more for Palatino
		% just some font experiments (ignore)
		%\RequirePackage{lmodern}
	%\RequirePackage[urw-garamond]{mathdesign}
	%\RequirePackage[light,condensed,math]{iwona}
	%\renewcommand{\sfdefault}{iwona}
}

\ifthenelse{\boolean{@eulermath}}%
{\RequirePackage[euler-digits]{eulervm}} % Euler math fonts
{\relax}

% ********************************************************************
% Textblock size
%*******************************************************
\PackageInfo{classicthesis}{A4 paper, Palatino or other}
\areaset[5mm]{390pt}{650pt} % 686 (factor 2.2) + 33 head + 42 head \the\footskip

% Randnotiz stuff ...
%\setlength{\marginparwidth}{7em}%
%\setlength{\marginparsep}{2em}%


	% Here are some suggestions for the text widths and heights:
	% Palatino 	10pt: 288--312pt | 609--657pt
	% Palatino 	11pt: 312--336pt | 657--705pt
	% Palatino 	12pt: 
	% Minion 	  10pt: 264--288pt | 561--609pt
	% Minion 	  11pt: 288--312pt | 609--657pt
	% Minion 	  12pt: 

	% ********************************************************************
	% Own Stuff
	% ********************************************************************
% Disable single lines at the start of a paragraph (Schusterjungen)
	\clubpenalty = 10000
% Disable single lines at the end of a paragraph (Hurenkinder)
	\widowpenalty = 10000 
	\displaywidowpenalty = 10000 % formulas

	% Graffiti as in GKP's book "Concrete Mathematics"
	\DeclareRobustCommand{\graffito}[1]{\marginpar{%
		\slshape\footnotesize%\small%
			\ifodd\thepage\raggedright\else\raggedleft\fi%
			\parindent=0pt\lineskip=0pt\lineskiplimit=0pt%\baselineskip=10pt
			\tolerance=2000\hyphenpenalty=300\exhyphenpenalty=300%
			\doublehyphendemerits=100000\finalhyphendemerits=\doublehyphendemerits%
			%\raggedright%
			\hspace{0pt}#1}}

			% Enumeration environment with small caps
			\newenvironment{aenumerate}
{\def\theenumi{\textsc{\alph{enumi}}}%
	\enumerate}
{\endenumerate}

% ********************************************************************
% Fancy Stuff
% ********************************************************************  
\RequirePackage{booktabs} % for better rules in tables
\RequirePackage[overload]{textcase} % for \MakeTextUppercase

\RequirePackage{soul} % for letterspacing 
\sodef\allcapsspacing{\upshape}{0.15em}{0.60em}{0.6em}%
\sodef\lowsmallcapsspacing{\scshape}{0.075em}{0.5em}{0.6em}%   
\DeclareRobustCommand{\spacedallcaps}[1]{\MakeTextUppercase{\allcapsspacing{#1}}}%   
\DeclareRobustCommand{\spacedlowsmallcaps}[1]{{\textsc{\lowsmallcapsspacing{#1}}}}%

% ********************************************************************                
% headlines
% ********************************************************************  
\RequirePackage[automark]{scrpage2} % provides headers and footers (KOMA Script)
\clearscrheadings
\clearscrheadfoot
\setheadsepline{0pt}

\renewcommand{\chaptermark}[1]{\markboth{\spacedlowsmallcaps{#1}}{\spacedlowsmallcaps{#1}}}
%\renewcommand{\sectionmark}[1]{\markright{\thesection\enspace\spacedlowsmallcaps{#1}}} 
\renewcommand{\sectionmark}[1]{\markright{\spacedlowsmallcaps{#1}}} 

\lehead{\small\headmark}
\rehead{\textsc{\small\thepage}}
\lohead{\textsc{\small\thepage}}
\rohead{\small\headmark}

% ********************************************************************
% figures are placed only within section they were declared in
% provides command \FloatBarrier
% ********************************************************************
%\RequirePackage[section,below]{placeins}    

% ********************************************************************
% layout of the chapter-, section-, subsection-, subsubsection-,
% paragraph and description-headings
% ********************************************************************             
\RequirePackage{titlesec}
% parts
\ifthenelse{\boolean{@parts}}%
{%
	\titleformat{\part}[display]
	{\normalfont\centering\large}%
	{\thispagestyle{empty}\partname~\MakeTextUppercase{\thepart}}{1em}%
	{\color{Maroon}\spacedallcaps}
}
{\relax}

\usepackage[overload]{textcase}

% chapters
\titleformat{\chapter}[display]%
{\relax}{{\chaptersc{\chaptertitlename}} \hspace*{0.5em} \MakeTextUppercase\thechapter}{0.3em}%
{\color{Maroon}\huge\raggedright\chaptersc\MakeTextUppercase}% 
%{\Large\raggedright\spacedallcaps}[\normalsize\vspace*{.8\baselineskip}\titlerule]% 
% sections
\titleformat{\section}
{\color{Maroon}}{\textsc{\MakeTextLowercase{\thesection}}}{1em}{\spacedlowsmallcaps}
% subsections
\titleformat{\subsection}
{\color{Maroon}}{\textsc{\MakeTextLowercase{\thesubsection}}}{1em}{\normalsize\itshape}
% subsubsections
\titleformat{\subsubsection}
{\color{Maroon}}{\textsc{\MakeTextLowercase{\thesubsubsection}}}{1em}{\normalsize\itshape}        
% paragraphs
\titleformat{\paragraph}[runin]
{\color{Maroon}\normalfont\normalsize}{\theparagraph}{0pt}{\spacedlowsmallcaps}    
% descriptionlabels
\renewcommand{\descriptionlabel}[1]{\hspace*{\labelsep}\spacedlowsmallcaps{#1}}   % spacedlowsmallcaps textit textsc                  
% spacing


\ifthenelse{\boolean{@nochapters}}%
{\relax}%
{
	\titlespacing*{\chapter}{0pt}{1\baselineskip}{6\baselineskip}}
	\titlespacing*{\section}{0pt}{1.25\baselineskip}{0.5\baselineskip} 
	\titlespacing*{\subsection}{0pt}{1.25\baselineskip}{0.5\baselineskip}
	\titlespacing*{\paragraph}{0pt}{1\baselineskip}{0.5\baselineskip}

	% ********************************************************************                
	% layout of the TOC, LOF and LOT (LOL-workaround see next section)
	% ********************************************************************
	\RequirePackage[titles]{tocloft}
	% avoid page numbers being right-aligned in fixed-size box              
	\newlength{\newnumberwidth}
	\settowidth{\newnumberwidth}{99} % yields overfull hbox warnings for pages > 99
	\cftsetpnumwidth{\newnumberwidth}
	% have the bib neatly positioned after the rest
	\newlength{\beforebibskip}  
	\setlength{\beforebibskip}{0em}
	% pagenumbers right after the titles
	% parts
	\ifthenelse{\boolean{@parts}}%
	{%
		\renewcommand{\thepart}{\roman{part}}%
		\renewcommand{\cftpartpresnum}{\scshape}%  \MakeTextLowercase
		%      \renewcommand{\cftpartaftersnum}{\cftchapaftersnum}%
		%      \renewcommand{\cftpartaftersnumb}{\quad}%
		%      \setlength{\cftpartnumwidth}{\cftpartnumwidth}
		\renewcommand{\cftpartfont}{\color{Maroon}\normalfont}%
		\renewcommand{\cftpartpagefont}{\normalfont}%
		\ifthenelse{\boolean{@dottedtoc}}{\relax}%
		{%
			\renewcommand{\cftpartleader}{\hspace{1.5em}}% 
				\renewcommand{\cftpartafterpnum}{\cftparfillskip}%
		}%        
		\setlength{\cftbeforepartskip}{1em}%
		\setlength{\cftbeforechapskip}{.1em}%
		\setlength{\beforebibskip}{\cftbeforepartskip}%
	}{\relax}

% chapters
\ifthenelse{\boolean{@nochapters}}%
{\relax}%
{%
	\renewcommand{\cftchappresnum}{\scshape\MakeTextLowercase}%
		\renewcommand{\cftchapfont}{\normalfont}%
		\renewcommand{\cftchappagefont}{\normalfont}%
		\ifthenelse{\boolean{@dottedtoc}}{\relax}%
		{%
			\renewcommand{\cftchapleader}{\hspace{1.5em}}% 
				\renewcommand{\cftchapafterpnum}{\cftparfillskip}% 
		}
	%\setlength{\cftbeforechapskip}{.1em}%           
}

% sections
\ifthenelse{\boolean{@nochapters}}%        
{%
	\setlength{\cftbeforesecskip}{.1em}%
		\setlength{\beforebibskip}{1em}%
}%
{\relax}
\renewcommand{\cftsecpresnum}{\scshape\MakeTextLowercase}%
\renewcommand{\cftsecfont}{\normalfont}%
\renewcommand{\cftsecpagefont}{\normalfont}%
\ifthenelse{\boolean{@dottedtoc}}{\relax}%
{%        
	\renewcommand{\cftsecleader}{\hspace{1.5em}}% 
		\renewcommand{\cftsecafterpnum}{\cftparfillskip}%
}
\ifthenelse{\boolean{@tocaligned}}{\renewcommand{\cftsecindent}{0em}}{\relax}

% subsections
\renewcommand{\cftsubsecpresnum}{\scshape\MakeTextLowercase}%
\renewcommand{\cftsubsecfont}{\normalfont}%
\ifthenelse{\boolean{@dottedtoc}}{\relax}%
{%      
	\renewcommand{\cftsubsecleader}{\hspace{1.5em}}% 
		\renewcommand{\cftsubsecafterpnum}{\cftparfillskip}%   
}             
\ifthenelse{\boolean{@tocaligned}}{\renewcommand{\cftsubsecindent}{0em}}{\relax}
% subsubsections
\renewcommand{\cftsubsubsecpresnum}{\scshape\MakeTextLowercase}%
\renewcommand{\cftsubsubsecfont}{\normalfont}%
\ifthenelse{\boolean{@dottedtoc}}{\relax}%
{%      
	\renewcommand{\cftsubsubsecleader}{\hspace{1.5em}}% 
		\renewcommand{\cftsubsubsecafterpnum}{\cftparfillskip}%   
}             
\ifthenelse{\boolean{@tocaligned}}{\renewcommand{\cftsubsubsecindent}{0em}}{\relax}
% figures     
\renewcommand{\cftfigpresnum}{\scshape\MakeTextLowercase}% 
\renewcommand{\cftfigfont}{\normalfont}%                 
\ifthenelse{\boolean{@dottedtoc}}{\relax}%
{%
	\renewcommand{\cftfigleader}{\hspace{1.5em}}% 
		\renewcommand{\cftfigafterpnum}{\cftparfillskip}%
}
\renewcommand{\cftfigpresnum}{\figurename~}%Fig.~}
\newlength{\figurelabelwidth}
\settowidth{\figurelabelwidth}{\cftfigpresnum~99}
\addtolength{\figurelabelwidth}{2.5em}
\cftsetindents{figure}{0em}{\figurelabelwidth}
% tables
\renewcommand{\cfttabpresnum}{\scshape\MakeTextLowercase}%
\renewcommand{\cfttabfont}{\normalfont}%
\ifthenelse{\boolean{@dottedtoc}}{\relax}%
{%
	\renewcommand{\cfttableader}{\hspace{1.5em}}% 
		\renewcommand{\cfttabafterpnum}{\cftparfillskip}%   
} 
\renewcommand{\cfttabpresnum}{\tablename~}%Tab.~}
\newlength{\tablelabelwidth}
\settowidth{\tablelabelwidth}{\cfttabpresnum~99}
\addtolength{\tablelabelwidth}{2.5em}
%\cftsetindents{table}{0em}{\tablelabelwidth}
\cftsetindents{table}{0em}{\figurelabelwidth}

% listings
\ifthenelse{\boolean{@listings}}%        
{%
	\renewcommand{\lstlistlistingname}{List of Listings}
	\newlistof{listings}{lol}{\lstlistlistingname}%
		\renewcommand{\cftlistingspresnum}{\scshape\MakeTextLowercase}%
		\renewcommand{\cftlistingsfont}{\normalfont}%
		\renewcommand{\cftlistingspresnum}{\lstlistingname~}%
		\renewcommand{\cftlistingspagefont}{\normalfont}%
		\ifthenelse{\boolean{@dottedtoc}}{\relax}%
		{%  
			\renewcommand{\cftlistingsleader}{\hspace{1.5em}}%
				\renewcommand{\cftlistingsafterpnum}{\cftparfillskip}%
		}
	\newlength{\listingslabelwidth}%
		\settowidth{\listingslabelwidth}{\cftlistingspresnum~99}%
		\addtolength{\listingslabelwidth}{2.5em}%
		%\cftsetindents{listings}{0em}{\listingslabelwidth}%
		\cftsetindents{listings}{0em}{\figurelabelwidth}%
		\let\l@lstlisting\l@listings%
		\let\lstlistoflistings\listoflistings%
}{\relax}%

% dirty work-around to get the spacing after the toc/lot/lof-titles right    
\ifthenelse{\boolean{@parts}}%        
{%
	\AtBeginDocument{\addtocontents{toc}{\protect\vspace{-\cftbeforepartskip}}}
}{%
	\ifthenelse{\boolean{@nochapters}}%
	{\relax}%
	{\AtBeginDocument{\addtocontents{toc}{\protect\vspace{-\cftbeforechapskip}}}}
}

% another dirty work-around to get the spaced low small caps into the toc ;-(
		\ifthenelse{\boolean{@nochapters}}%
		{\relax}%
		{%
		%% w/ optional parameter 
		\newcommand{\myChapter}[2][]{% for chapters
		\ifthenelse{\equal{#1}{}}{%  
		%\chapter[\tocEntry{#2}]{#2} % causes soul "reconstruction failed" with plain LaTeX    
		\ifpdf\chapter[\texorpdfstring{\spacedlowsmallcaps{#2}}{#2}]{#2}%
		\else\chapter[\spacedlowsmallcaps{#2}]{#2}\fi%
		}{%
		%\chapter[\tocEntry{#1}]{#2}
		\ifpdf\chapter[\texorpdfstring{\spacedlowsmallcaps{#1}}{#1}]{#2}%
		\else\chapter[\spacedlowsmallcaps{#1}]{#2}\fi%
		}}%
		}

		% yet another dirty work-around to get the spaced low small caps into the toc ;-(
			\ifthenelse{\boolean{@parts}}%
			{% 
			\newcommand{\myPart}[2][]{% for parts     
			\ifthenelse{\equal{#1}{}}{%  
			\ifpdf%
			% ugly hack to remove the part number from the PDF bookmark entry
			\pdfstringdefDisableCommands{\let\thepart\@gobbletwo}% 	        
			\part[\texorpdfstring{\spacedlowsmallcaps{#2}}{#2}]{#2}% spacedallcaps spacedlowsmallcaps	
			\else\part[\spacedlowsmallcaps{#2}]{#2}\fi%
			}{%
			\ifpdf%
			% ugly hack to remove the part number from the PDF bookmark entry
			\pdfstringdefDisableCommands{\let\thepart\@gobbletwo}% 	        
			\part[\texorpdfstring{\spacedlowsmallcaps{#1}}{#1}]{#2}% spacedallcaps spacedlowsmallcaps	
			\else\part[\spacedlowsmallcaps{#1}]{#2}\fi%
			}}%
			}{\relax}

			\newcommand{\tocEntry}[1]{% for bib, etc.
			\ifpdf\texorpdfstring{\spacedlowsmallcaps{#1}}{#1}%
				\else{#1}\fi%
			}

% remove the vertical space between lof/lot entries of different chapters
\ifthenelse{\boolean{@listsseparated}}{%
	\AtBeginDocument{%
		\addtocontents{lof}{\protect\vspace{-\cftbeforechapskip}}%
			\addtocontents{lot}{\protect\vspace{-\cftbeforechapskip}}%
	}%
}{%
	\DeclareRobustCommand*{\deactivateaddvspace}{\let\addvspace\@gobble}% 
		\AtBeginDocument{%      
			\addtocontents{lof}{\deactivateaddvspace}% 
				\addtocontents{lot}{\deactivateaddvspace}%      
				       }%
} 

% ********************************************************************
% footnotes setup   
% ********************************************************************
%\RequirePackage{footmisc}  % [bottom] norule para symbol* marginal perpage
% KOMA-command, footnotemark not superscripted at the bottom
\deffootnote[1em]{1em}{0em}{\textsc\thefootnotemark\hspace*{.5em}}      
%\setfnsymbol{bringhurst}   % use symbols recommended by guru Robert Bringhurst 
%\setlength{\footnotemargin}{-1em}     











